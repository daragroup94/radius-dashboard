{% extends "base.html" %}

{% block title %}Dashboard - RADIUS Manager{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Real-time Network Monitoring & Analytics{% endblock %}

{% block extra_css %}
<style>
    .stat-card-modern {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .stat-card-modern:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .icon-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .icon-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .icon-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .icon-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .icon-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .icon-gradient-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
    
    .floating-icon { animation: float 3s ease-in-out infinite; }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .shimmer { position: relative; overflow: hidden; }
    
    .shimmer::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        100% { left: 100%; }
    }
    
    .activity-item-modern {
        transition: all 0.3s ease;
    }
    
    .activity-item-modern:hover {
        transform: translateX(8px);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Modern Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users -->
        <div class="stat-card-modern rounded-3xl p-6 shadow-xl shimmer">
            <div class="flex items-center justify-between mb-4">
                <div class="w-16 h-16 icon-gradient-1 rounded-2xl flex items-center justify-center shadow-lg floating-icon">
                    <i class="fas fa-users text-white text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Users</p>
                    <p class="text-4xl font-bold text-gray-800 mt-1" id="totalUsers">0</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">
                    <i class="fas fa-arrow-up mr-1"></i>Active
                </span>
                <span class="text-xs text-gray-500" id="activeUsers">PPPoE users</span>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="stat-card-modern rounded-3xl p-6 shadow-xl shimmer">
            <div class="flex items-center justify-between mb-4">
                <div class="w-16 h-16 icon-gradient-2 rounded-2xl flex items-center justify-center shadow-lg floating-icon" style="animation-delay: 0.5s">
                    <i class="fas fa-signal text-white text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Live Sessions</p>
                    <p class="text-4xl font-bold text-gray-800 mt-1" id="activeSessions">0</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">
                    <i class="fas fa-wifi mr-1"></i>Online
                </span>
                <span class="text-xs text-gray-500">connections</span>
            </div>
        </div>

        <!-- Auth Attempts -->
        <div class="stat-card-modern rounded-3xl p-6 shadow-xl shimmer">
            <div class="flex items-center justify-between mb-4">
                <div class="w-16 h-16 icon-gradient-3 rounded-2xl flex items-center justify-center shadow-lg floating-icon" style="animation-delay: 1s">
                    <i class="fas fa-key text-white text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Auth Today</p>
                    <p class="text-4xl font-bold text-gray-800 mt-1" id="authAttempts">0</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                    <i class="fas fa-check mr-1"></i>Success
                </span>
                <span class="text-xs text-gray-500">authentication</span>
            </div>
        </div>

        <!-- NAS Devices -->
        <div class="stat-card-modern rounded-3xl p-6 shadow-xl shimmer">
            <div class="flex items-center justify-between mb-4">
                <div class="w-16 h-16 icon-gradient-4 rounded-2xl flex items-center justify-center shadow-lg floating-icon" style="animation-delay: 1.5s">
                    <i class="fas fa-server text-white text-2xl"></i>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">NAS Devices</p>
                    <p class="text-4xl font-bold text-gray-800 mt-1" id="nasDevices">0</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">
                    <i class="fas fa-check-circle mr-1"></i>Online
                </span>
                <span class="text-xs text-gray-500">network devices</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Authentication Activity Chart -->
        <div class="modern-card p-6 rounded-3xl">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 icon-gradient-5 rounded-xl flex items-center justify-center mr-3 shadow-md">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Authentication Activity</h3>
                        <p class="text-sm text-gray-500">Last 24 hours</p>
                    </div>
                </div>
                <button onclick="refreshActivityChart()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-xl transition-all duration-200">
                    <i class="fas fa-sync-alt text-gray-600"></i>
                </button>
            </div>
            <div id="authActivityChart" style="height: 320px;"></div>
        </div>

        <!-- Sessions Distribution -->
        <div class="modern-card p-6 rounded-3xl">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 icon-gradient-6 rounded-xl flex items-center justify-center mr-3 shadow-md">
                        <i class="fas fa-chart-pie text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Sessions by NAS</h3>
                        <p class="text-sm text-gray-500">Current distribution</p>
                    </div>
                </div>
                <button onclick="refreshSessionsChart()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-xl transition-all duration-200">
                    <i class="fas fa-sync-alt text-gray-600"></i>
                </button>
            </div>
            <div id="sessionsPieChart" style="height: 320px;"></div>
        </div>
    </div>

    <!-- Recent Activity & Performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Activity -->
        <div class="modern-card p-6 rounded-3xl">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 icon-gradient-1 rounded-xl flex items-center justify-center mr-3 shadow-md">
                    <i class="fas fa-history text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Recent Activity</h3>
                    <p class="text-sm text-gray-500">Last 30 minutes</p>
                </div>
            </div>
            <div class="space-y-3 max-h-80 overflow-y-auto" id="recentActivityList">
                <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                    <div class="w-2 h-2 bg-gray-400 rounded-full mr-3 animate-pulse"></div>
                    <span class="text-sm text-gray-500">Loading activity...</span>
                </div>
            </div>
        </div>

        <!-- System Performance -->
        <div class="modern-card p-6 rounded-3xl">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 icon-gradient-3 rounded-xl flex items-center justify-center mr-3 shadow-md">
                    <i class="fas fa-tachometer-alt text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">System Performance</h3>
                    <p class="text-sm text-gray-500">Real-time metrics</p>
                </div>
            </div>
            <div class="space-y-6">
                <div data-metric="cpu">
                    <div class="flex justify-between mb-3">
                        <span class="text-sm font-semibold text-gray-700">CPU Usage</span>
                        <span class="text-sm font-bold text-gray-800 metric-value">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="h-3 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-1000 metric-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div data-metric="memory">
                    <div class="flex justify-between mb-3">
                        <span class="text-sm font-semibold text-gray-700">Memory Usage</span>
                        <span class="text-sm font-bold text-gray-800 metric-value">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="h-3 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 transition-all duration-1000 metric-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div data-metric="db">
                    <div class="flex justify-between mb-3">
                        <span class="text-sm font-semibold text-gray-700">Database Connections</span>
                        <span class="text-sm font-bold text-gray-800 metric-value">0 / 100</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="h-3 rounded-full bg-gradient-to-r from-purple-400 to-violet-500 transition-all duration-1000 metric-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div data-metric="disk">
                    <div class="flex justify-between mb-3">
                        <span class="text-sm font-semibold text-gray-700">Network Bandwidth</span>
                        <span class="text-sm font-bold text-gray-800 metric-value">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="h-3 rounded-full bg-gradient-to-r from-pink-400 to-rose-500 transition-all duration-1000 metric-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Script tetap sama seperti sebelumnya, hanya update style chart saja
let authActivityChart = null;
let sessionsPieChart = null;

async function loadStats() {
    try {
        const data = await apiCall('/api/stats');
        document.getElementById('totalUsers').textContent = data.total_users || 0;
        document.getElementById('activeSessions').textContent = data.active_sessions || 0;
        document.getElementById('authAttempts').textContent = data.today_auth || 0;
        document.getElementById('nasDevices').textContent = data.total_nas || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function createAuthActivityChart() {
    try {
        const response = await fetch('/api/auth-activity');
        const result = await response.json();
        
        const chartDom = document.getElementById('authActivityChart');
        if (authActivityChart) authActivityChart.dispose();
        authActivityChart = echarts.init(chartDom);
        
        const option = {
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e0e0e0',
                borderWidth: 1,
                textStyle: { color: '#333', fontSize: 14 },
                extraCssText: 'box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px; padding: 12px;'
            },
            grid: { left: '3%', right: '4%', bottom: '3%', top: '10%', containLabel: true },
            xAxis: {
                type: 'category',
                data: result.labels || [],
                axisLine: { lineStyle: { color: '#e0e0e0' } },
                axisLabel: { color: '#666', fontSize: 12, fontWeight: 500 }
            },
            yAxis: {
                type: 'value',
                axisLine: { show: false },
                axisTick: { show: false },
                axisLabel: { color: '#666', fontSize: 12 },
                splitLine: { lineStyle: { color: '#f0f0f0', type: 'dashed' } }
            },
            series: [{
                name: 'Auth Attempts',
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 8,
                lineStyle: { width: 4 },
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#667eea' },
                        { offset: 1, color: '#764ba2' }
                    ])
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(102, 126, 234, 0.4)' },
                        { offset: 1, color: 'rgba(118, 75, 162, 0.1)' }
                    ])
                },
                data: result.data || []
            }]
        };
        
        authActivityChart.setOption(option);
    } catch (error) {
        console.error('Error loading auth activity:', error);
    }
}

async function createSessionsPieChart() {
    try {
        const response = await fetch('/api/sessions-by-nas');
        const result = await response.json();
        
        const chartDom = document.getElementById('sessionsPieChart');
        if (sessionsPieChart) sessionsPieChart.dispose();
        sessionsPieChart = echarts.init(chartDom);
        
        const data = (result.labels || []).map((label, index) => ({
            name: label,
            value: (result.data || [])[index] || 0
        }));
        
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0'];
        
        const option = {
            color: colors,
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e0e0e0',
                borderWidth: 1,
                textStyle: { color: '#333', fontSize: 14 },
                extraCssText: 'box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px;'
            },
            legend: {
                bottom: '5%',
                left: 'center',
                textStyle: { color: '#666', fontSize: 13, fontWeight: 500 }
            },
            series: [{
                name: 'Sessions',
                type: 'pie',
                radius: ['50%', '75%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 12,
                    borderColor: '#fff',
                    borderWidth: 4
                },
                label: { show: false },
                emphasis: {
                    label: { show: true, fontSize: 20, fontWeight: 'bold' }
                },
                labelLine: { show: false },
                data: data
            }]
        };
        
        sessionsPieChart.setOption(option);
    } catch (error) {
        console.error('Error loading sessions distribution:', error);
    }
}

async function loadRecentActivity() {
    try {
        const activities = await apiCall('/api/recent-activity');
        const activityList = document.getElementById('recentActivityList');
        
        if (!activities || activities.length === 0) {
            activityList.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">No recent activity</div>';
            return;
        }
        
        activityList.innerHTML = activities.map(activity => {
            const colors = {
                green: 'from-green-50 to-emerald-50 border-green-200',
                red: 'from-red-50 to-rose-50 border-red-200',
                blue: 'from-blue-50 to-indigo-50 border-blue-200',
                purple: 'from-purple-50 to-violet-50 border-purple-200'
            };
            const iconBg = {
                green: 'bg-green-500',
                red: 'bg-red-500',
                blue: 'bg-blue-500',
                purple: 'bg-purple-500'
            };
            return `
            <div class="activity-item-modern flex items-center p-4 bg-gradient-to-r ${colors[activity.color] || colors.blue} rounded-xl border">
                <div class="w-12 h-12 ${iconBg[activity.color] || iconBg.blue} rounded-xl flex items-center justify-center mr-4 shadow-md">
                    <i class="fas ${activity.icon} text-white"></i>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-gray-800">${activity.text}</p>
                    <p class="text-sm text-gray-500">${activity.time}</p>
                </div>
                ${activity.color === 'green' || activity.color === 'blue' ? '<div class="w-3 h-3 bg-' + activity.color + '-500 rounded-full pulse-dot"></div>' : ''}
            </div>
        `}).join('');
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
}

async function loadPerformanceMetrics() {
    try {
        const metrics = await apiCall('/api/system-metrics');
        updateMetric('cpu', metrics.cpu_percent, `${metrics.cpu_percent}%`);
        updateMetric('memory', metrics.memory_percent, `${metrics.memory_percent}%`);
        const dbPercent = (metrics.db_connections / metrics.db_max_connections) * 100;
        updateMetric('db', dbPercent, `${metrics.db_connections} / ${metrics.db_max_connections}`);
        updateMetric('disk', metrics.disk_percent, `${metrics.disk_percent}%`);
    } catch (error) {
        console.error('Error loading performance metrics:', error);
    }
}

function updateMetric(metricName, percent, valueText) {
    const element = document.querySelector(`[data-metric="${metricName}"]`);
    if (!element) return;
    const valueEl = element.querySelector('.metric-value');
    const barEl = element.querySelector('.metric-bar');
    if (valueEl) valueEl.textContent = valueText;
    if (barEl) barEl.style.width = `${percent}%`;
}

function refreshActivityChart() {
    createAuthActivityChart();
    showNotification('Chart refreshed', 'success');
}

function refreshSessionsChart() {
    createSessionsPieChart();
    showNotification('Chart refreshed', 'success');
}

function refreshAllData() {
    loadStats();
    loadPerformanceMetrics();
    loadRecentActivity();
    createAuthActivityChart();
    createSessionsPieChart();
}

document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    createAuthActivityChart();
    createSessionsPieChart();
    loadRecentActivity();
    loadPerformanceMetrics();
    setInterval(refreshAllData, 30000);
});

window.addEventListener('beforeunload', () => {
    if (authActivityChart) authActivityChart.dispose();
    if (sessionsPieChart) sessionsPieChart.dispose();
});
</script>
{% endblock %}

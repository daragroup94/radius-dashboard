{% extends "base.html" %}

{% block title %}Network Maps - Radius Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header dengan Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4 pt-3">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Network Maps</h1>
            <p class="text-muted">Monitor pelanggan dan infrastruktur jaringan</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary active" id="toggleODPBtn" onclick="toggleODPLayer()">
                <i class="fas fa-network-wired"></i> ODP
            </button>
            <button class="btn btn-success active" id="toggleCustomerBtn" onclick="toggleCustomerLayer()">
                <i class="fas fa-users"></i> Customers
            </button>
            <button class="btn btn-info" id="refreshBtn" onclick="refreshMap()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Pelanggan</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-customers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Online Sekarang</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="online-customers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wifi fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total ODP</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-odp">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-network-wired fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total ODC</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-odc">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filter & Controls</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Filter Status:</strong></label>
                    <select class="form-select" onchange="filterByStatus(this.value)">
                        <option value="all">Semua Pelanggan</option>
                        <option value="online">Online Saja</option>
                        <option value="offline">Offline Saja</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Filter ODP:</strong></label>
                    <select class="form-select" onchange="filterByODP(this.value)">
                        <option value="all">Semua ODP</option>
                        <!-- ODP options akan di-load secara dinamis -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Auto Refresh:</strong></label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Setiap 30 detik</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Peta Jaringan</h6>
        </div>
        <div class="card-body p-0">
            <div id="google-map" style="height: 600px; width: 100%; border-radius: 0 0 8px 8px;"></div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Google Maps API tanpa callback -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBClnQ74K6CNqZ1UgzFj9CGriGy5TOqDck&loading=async"></script>

<!-- Custom Maps JS -->
<script src="{{ url_for('static', filename='js/network_maps.js') }}"></script>

<script>
// Initialize map after both scripts are loaded
function initializeApp() {
    // Tunggu sampai Google Maps API siap
    if (typeof google !== 'undefined' && google.maps) {
        initGoogleMap();
    } else {
        // Jika Google Maps belum ready, tunggu sebentar
        setTimeout(initializeApp, 100);
    }
}

// Auto refresh functionality
let autoRefreshInterval;

document.getElementById('autoRefresh').addEventListener('change', function(e) {
    if (e.target.checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
});

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        refreshMap();
    }, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

// Start everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    startAutoRefresh();
});
</script>
{% endblock %}

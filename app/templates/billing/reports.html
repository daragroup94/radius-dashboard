{% extends "base.html" %}

{% block title %}Laporan Keuangan - RADIUS Dashboard{% endblock %}
{% block page_title %}Laporan Keuangan{% endblock %}
{% block page_subtitle %}Analisis dan statistik performa billing{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header dengan Filter -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div class="flex space-x-3">
            <select id="periodFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="6">6 Bulan Terakhir</option>
                <option value="12">12 Bulan Terakhir</option>
                <option value="3">3 Bulan Terakhir</option>
            </select>
            <button onclick="loadReports()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-refresh mr-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- ðŸŽ¨ GRADIENT CARDS - INI YANG BARU -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1">Total Pendapatan</p>
                    <p id="totalRevenue" class="text-3xl font-bold">Rp 0</p>
                    <p class="text-xs opacity-75 mt-1">Semua periode</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <i class="fas fa-money-bill-wave text-3xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1">Bulan Ini</p>
                    <p id="monthlyRevenue" class="text-3xl font-bold">Rp 0</p>
                    <p id="monthlyGrowth" class="text-xs opacity-75 mt-1">
                        <i class="fas fa-arrow-up"></i> +0% vs bulan lalu
                    </p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <i class="fas fa-calendar-alt text-3xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1">Invoice Tertunggak</p>
                    <p id="unpaidCount" class="text-3xl font-bold">0</p>
                    <p id="unpaidAmount" class="text-xs opacity-75 mt-1">Rp 0 pending</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-3xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90 mb-1">Pelanggan Aktif</p>
                    <p id="activeCustomers" class="text-3xl font-bold">0</p>
                    <p id="customerGrowth" class="text-xs opacity-75 mt-1">
                        <i class="fas fa-user-plus"></i> +0 bulan ini
                    </p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <i class="fas fa-users text-3xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ“Š CHARTS ROW -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Revenue Chart Besar -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Trend Pendapatan</h3>
                    <p class="text-sm text-gray-500">Perbandingan pendapatan bulanan</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="changeChartType('line')" id="btnLineChart" class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded">
                        <i class="fas fa-chart-line mr-1"></i>Line
                    </button>
                    <button onclick="changeChartType('bar')" id="btnBarChart" class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded">
                        <i class="fas fa-chart-bar mr-1"></i>Bar
                    </button>
                </div>
            </div>
            <canvas id="revenueChart" height="100"></canvas>
        </div>

        <!-- Package Pie Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Distribusi Paket</h3>
            <canvas id="packagePieChart" height="250"></canvas>
            <div id="packageLegend" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- ðŸ“ˆ SECONDARY CHARTS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Metode Pembayaran</h3>
            <canvas id="paymentMethodChart" height="200"></canvas>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Pertumbuhan Invoice</h3>
            <canvas id="customerGrowthChart" height="200"></canvas>
        </div>
    </div>

    <!-- ðŸ“‹ PACKAGE PERFORMANCE TABLE -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-6">Performa Paket</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paket</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pelanggan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Share</th>
                    </tr>
                </thead>
                <tbody id="packagePerformanceTable" class="divide-y divide-gray-200">
                    <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ðŸ“… MONTHLY DETAILS -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-6">Detail Bulanan</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Periode</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lunas</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pending</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody id="monthlyDetails" class="divide-y divide-gray-200">
                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let revenueChart, packagePieChart, paymentMethodChart, customerGrowthChart;
let currentChartType = 'line';
let reportsData = null;

const colorSchemes = {
    primary: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
    green: { start: 'rgba(16, 185, 129, 0.8)', end: 'rgba(16, 185, 129, 0.1)' }
};

function loadReports() {
    console.log('ðŸ”„ Loading reports...');
    
    $.get('/api/billing/reports/summary')
    .done(function(data) {
        console.log('âœ… Data loaded:', data);
        reportsData = data;
        updateCards(data);
        createRevenueChart(data.monthly_income);
        createPackagePieChart(data.package_performance);
        createPaymentMethodChart(data.payment_methods);
        createCustomerGrowthChart(data.monthly_income);
        updatePackageTable(data.package_performance);
        updateMonthlyTable(data.monthly_income);
        showNotification('Data berhasil dimuat', 'success');
    })
    .fail(function(xhr, status, error) {
        console.error('âŒ Load error:', error);
        showNotification('Gagal memuat data', 'error');
    });
}

function updateCards(data) {
    let totalRevenue = 0;
    let monthlyRevenue = 0;
    let lastMonthRevenue = 0;
    let unpaidCount = 0;
    let unpaidAmount = 0;
    let activeCustomers = 0;

    if (data.monthly_income && data.monthly_income.length > 0) {
        monthlyRevenue = parseFloat(data.monthly_income[0].paid_amount || 0);
        if (data.monthly_income.length > 1) {
            lastMonthRevenue = parseFloat(data.monthly_income[1].paid_amount || 0);
        }
        
        data.monthly_income.forEach(month => {
            totalRevenue += parseFloat(month.paid_amount || 0);
            unpaidAmount += parseFloat(month.pending_amount || 0);
        });
    }

    if (data.package_performance) {
        data.package_performance.forEach(pkg => {
            activeCustomers += parseInt(pkg.customer_count || 0);
        });
    }

    const growthPercent = lastMonthRevenue > 0 
        ? ((monthlyRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1)
        : 0;

    $('#totalRevenue').text('Rp ' + Math.round(totalRevenue).toLocaleString('id-ID'));
    $('#monthlyRevenue').text('Rp ' + Math.round(monthlyRevenue).toLocaleString('id-ID'));
    $('#monthlyGrowth').html(`<i class="fas fa-arrow-${growthPercent >= 0 ? 'up' : 'down'}"></i> ${growthPercent >= 0 ? '+' : ''}${growthPercent}% vs bulan lalu`);
    $('#unpaidCount').text(unpaidCount);
    $('#unpaidAmount').text('Rp ' + Math.round(unpaidAmount).toLocaleString('id-ID') + ' pending');
    $('#activeCustomers').text(activeCustomers);
}

function createRevenueChart(monthlyData) {
    const ctx = document.getElementById('revenueChart');
    if (!ctx || !monthlyData || monthlyData.length === 0) return;
    
    if (revenueChart) revenueChart.destroy();
    
    const period = parseInt($('#periodFilter').val()) || 6;
    const recentMonths = monthlyData.slice(0, period).reverse();
    
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
    const labels = recentMonths.map(m => `${monthNames[m.month - 1]} ${m.year}`);
    const paidData = recentMonths.map(m => m.paid_amount || 0);
    const totalData = recentMonths.map(m => m.total_amount || 0);
    
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorSchemes.green.start);
    gradient.addColorStop(1, colorSchemes.green.end);
    
    revenueChart = new Chart(ctx, {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Pendapatan Lunas',
                data: paidData,
                borderColor: '#10b981',
                backgroundColor: currentChartType === 'line' ? gradient : 'rgba(16, 185, 129, 0.8)',
                borderWidth: 3,
                tension: 0.4,
                fill: currentChartType === 'line',
                pointRadius: 5
            }, {
                label: 'Total Invoice',
                data: totalData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.dataset.label + ': Rp ' + Math.round(ctx.parsed.y).toLocaleString('id-ID')
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: v => v >= 1000000 ? 'Rp ' + (v/1000000).toFixed(1) + 'M' : 'Rp ' + (v/1000).toFixed(0) + 'K'
                    }
                }
            }
        }
    });
}

function createPackagePieChart(packageData) {
    const ctx = document.getElementById('packagePieChart');
    if (!ctx || !packageData || packageData.length === 0) return;
    
    if (packagePieChart) packagePieChart.destroy();
    
    const labels = packageData.map(p => p.package_name);
    const data = packageData.map(p => p.customer_count || 0);
    
    packagePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colorSchemes.primary,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
    
    let legendHtml = '';
    const total = data.reduce((a, b) => a + b, 0);
    packageData.forEach((pkg, i) => {
        const pct = ((data[i] / total) * 100).toFixed(1);
        legendHtml += `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${colorSchemes.primary[i]}"></div>
                    <span class="text-sm">${pkg.package_name}</span>
                </div>
                <span class="text-sm font-semibold">${pct}%</span>
            </div>
        `;
    });
    $('#packageLegend').html(legendHtml);
}

function createPaymentMethodChart(paymentData) {
    const ctx = document.getElementById('paymentMethodChart');
    if (!ctx || !paymentData || paymentData.length === 0) return;
    
    if (paymentMethodChart) paymentMethodChart.destroy();
    
    const labels = paymentData.map(m => m.payment_method.toUpperCase());
    const amounts = paymentData.map(m => m.total_amount || 0);
    
    paymentMethodChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: amounts,
                backgroundColor: colorSchemes.primary,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function createCustomerGrowthChart(monthlyData) {
    const ctx = document.getElementById('customerGrowthChart');
    if (!ctx || !monthlyData || monthlyData.length === 0) return;
    
    if (customerGrowthChart) customerGrowthChart.destroy();
    
    const recentMonths = monthlyData.slice(0, 6).reverse();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
    const labels = recentMonths.map(m => monthNames[m.month - 1]);
    const data = recentMonths.map(m => m.invoice_count || 0);
    
    customerGrowthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Invoice',
                data: data,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function updatePackageTable(packageData) {
    if (!packageData || packageData.length === 0) {
        $('#packagePerformanceTable').html('<tr><td colspan="5" class="px-6 py-4 text-center">Tidak ada data</td></tr>');
        return;
    }
    
    const totalRevenue = packageData.reduce((sum, p) => sum + parseFloat(p.total_revenue || 0), 0);
    
    let html = '';
    packageData.forEach(pkg => {
        const revenue = parseFloat(pkg.total_revenue || 0);
        const share = totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) : 0;
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4"><div class="font-medium">${pkg.package_name}</div></td>
                <td class="px-6 py-4 text-sm">${pkg.customer_count || 0}</td>
                <td class="px-6 py-4 text-sm">${pkg.invoice_count || 0}</td>
                <td class="px-6 py-4 text-sm font-semibold text-green-600">Rp ${Math.round(revenue).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${share}%"></div>
                        </div>
                        <span class="text-sm">${share}%</span>
                    </div>
                </td>
            </tr>
        `;
    });
    
    $('#packagePerformanceTable').html(html);
}

function updateMonthlyTable(monthlyData) {
    if (!monthlyData || monthlyData.length === 0) {
        $('#monthlyDetails').html('<tr><td colspan="6" class="px-6 py-4 text-center">Tidak ada data</td></tr>');
        return;
    }
    
    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    let html = '';
    monthlyData.forEach(month => {
        const paidAmount = parseFloat(month.paid_amount || 0);
        const totalAmount = parseFloat(month.total_amount || 0);
        const paymentRate = totalAmount > 0 ? ((paidAmount / totalAmount) * 100).toFixed(0) : 0;
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4"><div class="font-medium">${monthNames[month.month - 1]} ${month.year}</div></td>
                <td class="px-6 py-4 text-sm">${month.invoice_count || 0}</td>
                <td class="px-6 py-4 text-sm">Rp ${Math.round(totalAmount).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4 text-sm font-semibold text-green-600">Rp ${Math.round(paidAmount).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4 text-sm text-red-600">Rp ${Math.round(parseFloat(month.pending_amount || 0)).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: ${paymentRate}%"></div>
                        </div>
                        <span class="text-xs font-medium">${paymentRate}%</span>
                    </div>
                </td>
            </tr>
        `;
    });
    
    $('#monthlyDetails').html(html);
}

function changeChartType(type) {
    currentChartType = type;
    $('#btnLineChart, #btnBarChart').removeClass('bg-blue-100 text-blue-600').addClass('bg-gray-100 text-gray-600');
    $('#btn' + (type === 'line' ? 'Line' : 'Bar') + 'Chart').removeClass('bg-gray-100 text-gray-600').addClass('bg-blue-100 text-blue-600');
    if (reportsData && reportsData.monthly_income) createRevenueChart(reportsData.monthly_income);
}

function showNotification(message, type = 'info') {
    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
    const div = document.createElement('div');
    div.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    div.innerHTML = `<div class="flex items-center"><i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle mr-2"></i><span>${message}</span></div>`;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

$(document).ready(function() {
    console.log('ðŸš€ Reports page loaded');
    loadReports();
    $('#periodFilter').on('change', () => reportsData && reportsData.monthly_income && createRevenueChart(reportsData.monthly_income));
});
</script>
{% endblock %}
